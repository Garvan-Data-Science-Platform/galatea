##To complete installation, need to go to: https://console.cloud.google.com/net-services/loadbalancing/ and replace the HTTP frontend with a HTTPS one
##

resource "google_compute_managed_ssl_certificate" "lb_default" {
  provider = google-beta
  name     = "api-${var.subdomain}-ssl-cert"
  project = var.project_id

  managed {
    domains = ["api.${var.subdomain}.dsp.garvan.org.au"]
  }
}

resource "google_compute_global_address" "api-static" {
  name = "ipv4-address"
}

data "google_compute_global_address" "api-static" {
  name = "ipv4-address"
}

resource "kubernetes_service" "primary" {
  
  metadata {
    annotations = {
      "cloud.google.com/neg": "{\"ingress\": true}",
    }
    name = "primary"
    labels = {
        App = "web"
    }
  }
  spec {
    selector = {
      App = "web" #This should match the kubernetes deployment
    }
    port {
      port = 80
      target_port = 5000
    }

    type = "NodePort"
  }
}

resource "kubernetes_ingress_v1" "gke-ingress" {
  wait_for_load_balancer = true
  metadata {
    name = "gke-ingress"
    annotations = {
        "kubernetes.io/ingress.global-static-ip-name"=google_compute_global_address.api-static.name
        "kubernetes.io/ingress.class"="gce"
        "ingress.gcp.kubernetes.io/pre-shared-cert"=google_compute_managed_ssl_certificate.lb_default.name
    }
  }

  spec {
    default_backend {
      service {
        name = "primary"
        port {
          number = 80
        }
      }
    }
  }
}

resource "google_dns_record_set" "api" {

  name = "api.${var.subdomain}.dsp.garvan.org.au."
  type = "A"
  ttl  = 300

  managed_zone = "dsp"
  project = "ctrl-358804"

  rrdatas = [data.google_compute_global_address.api-static.address]
}